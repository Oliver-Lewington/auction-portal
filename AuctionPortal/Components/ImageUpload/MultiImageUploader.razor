@typeparam TImage where TImage : class, ICarouselImage

@using AuctionPortal.Components.ImageUpload.Shared
@using AuctionPortal.Components.ImageViewer
@using AuctionPortal.Data.Models
@using AuctionPortal.ViewModels
@using MudBlazor
@using AuctionPortal.Dialogs
@using AuctionPortal.Services

@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IBlobStorageService BlobStorageService

<MudPaper Class="pa-6 rounded-lg elevation-3">

    <!-- Toolbar -->
    <MudToolBar Dense="true" WrapContent="true" Class="justify-space-between">

        <!-- Upload -->
        <MudTooltip Text="Upload image(s)">
            <MudFileUpload T="IReadOnlyList<IBrowserFile>"
                           Accept=".png, .jpg, .jpeg"
                           FilesChanged="UploadFiles"
                           MaximumFileCount="100">
                <ActivatorContent>
                    <MudIconButton Color="Color.Primary" Icon="@Icons.Material.Filled.CloudUpload" />
                </ActivatorContent>
            </MudFileUpload>
        </MudTooltip>

        <!-- Delete -->
        <MudTooltip Text="Delete selected image">
            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                           Color="Color.Error"
                           Disabled="@(!_hasSelected)"
                           OnClick="DeleteSelectedImage" />
        </MudTooltip>

        <!-- Zoom In / Zoom Out -->
        <MudTooltip Text="Zoom In">
            <MudIconButton Icon="@Icons.Material.Filled.ZoomIn"
                           Disabled="@(!_hasSelected)"
                           OnClick="ZoomIn" />
        </MudTooltip>
        <MudTooltip Text="Zoom Out">
            <MudIconButton Icon="@Icons.Material.Filled.ZoomOut"
                           Disabled="@(!_hasSelected || zoomLevel <= 1.0)"
                           OnClick="ZoomOut" />
        </MudTooltip>

        @if (AllowMultiple)
        {
            <MudTooltip Text="Move Left">
                <MudIconButton Icon="@Icons.Material.Filled.ArrowBackIos"
                               Disabled="@(!_hasSelected || selectedIndex == 0)"
                               OnClick="MoveLeft" />
            </MudTooltip>
            <MudTooltip Text="Move Right">
                <MudIconButton Icon="@Icons.Material.Filled.ArrowForwardIos"
                               Disabled="@(!_hasSelected || selectedIndex >= Images.Count - 1)"
                               OnClick="MoveRight" />
            </MudTooltip>
        }
    </MudToolBar>

    <!-- Image carousel -->
    <ImageCarousel Images="Images"
                   @bind-SelectedIndex="selectedIndex"
                   ZoomLevel="@zoomLevel" />

</MudPaper>

@code {
    [Parameter] public List<TImage> Images { get; set; } = new();
    [Parameter] public EventCallback<List<TImage>> ImagesChanged { get; set; }
    [Parameter] public bool AllowMultiple { get; set; } = true;

    private int selectedIndex = 0;
    private double zoomLevel = 1.0;
    private bool _hasSelected => selectedIndex >= 0 && selectedIndex < Images.Count;
    public TImage? SelectedImage => _hasSelected ? Images[selectedIndex] : null;

    private async Task UploadFiles(IReadOnlyList<IBrowserFile> files)
    {
        foreach (var file in files)
        {
            if (!file.ContentType.StartsWith("image/"))
            {
                Snackbar.Add($"{file.Name} is not an image.", Severity.Warning);
                continue;
            }

            try
            {
                var uploaded = await BlobStorageService.UploadAsync(file) as TImage
                               ?? throw new InvalidCastException("Uploaded file could not be converted to the expected image type.");

                if (!AllowMultiple)
                {
                    Images.Clear();
                    Images.Add(uploaded);
                    selectedIndex = 0;
                    break;
                }

                Images.Add(uploaded);
                Snackbar.Add($"Uploaded {file.Name} successfully", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Failed to upload {file.Name}: {ex.Message}", Severity.Error);
            }
        }

        if (!_hasSelected && Images.Count > 0)
            selectedIndex = 0;

        await ImagesChanged.InvokeAsync(Images);
    }

    private async Task DeleteSelectedImage()
    {
        if (!_hasSelected) return;

        var parameters = new DialogParameters<DeleteDialog>
        {
            { dl => dl.ContentText, "Do you really want to delete this image? This process cannot be undone." },
            { dl => dl.ButtonText, "Delete" },
            { dl => dl.Color, Color.Error }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall, FullWidth = true };
        var dialog = await DialogService.ShowAsync<DeleteDialog>("Confirm Delete", parameters, options);
        var result = await dialog.Result;

        if (result is not null && result.Canceled)
            return;

        Images.RemoveAt(selectedIndex);
        Snackbar.Add("Image deleted.", Severity.Error);

        selectedIndex = Images.Count > 0 ? Math.Min(selectedIndex, Images.Count - 1) : -1;

        StateHasChanged();
        await ImagesChanged.InvokeAsync(Images);
    }

    private void ZoomIn() => zoomLevel = Math.Min(zoomLevel + 0.1, 2.0);
    private void ZoomOut() => zoomLevel = Math.Max(zoomLevel - 0.1, 0.5);
    private void MoveLeft()
    {
        if (!_hasSelected || selectedIndex == 0) return;
        (Images[selectedIndex - 1], Images[selectedIndex]) = (Images[selectedIndex], Images[selectedIndex - 1]);
        selectedIndex--;
    }
    private void MoveRight()
    {
        if (!_hasSelected || selectedIndex >= Images.Count - 1) return;
        (Images[selectedIndex + 1], Images[selectedIndex]) = (Images[selectedIndex], Images[selectedIndex + 1]);
        selectedIndex++;
    }
}
